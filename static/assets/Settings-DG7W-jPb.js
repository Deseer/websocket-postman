import{e as H,c as ie,m as me}from"./api-CvrMnlWK.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{o as ce,q as pe,a as r,c as f,d as e,w as o,b as s,e as N,i as k,F as D,j as P,f as h,t as O,E as L,g as i,s as J,r as u,k as fe,n as _e}from"./index-gfZSHxez.js";const ge={class:"settings-page"},be={class:"card"},Ve={class:"card"},ye={class:"section-header"},we={key:0,class:"empty-tip"},ke={class:"card"},he={class:"card"},Ue={class:"card logs-card"},xe={class:"logs-header"},Re={key:0,class:"empty-tip"},Ce={class:"log-time"},Ne={class:"log-level"},Le={class:"log-message"},Se={class:"card"},Ae={key:0,class:"save-bar"},X=500,Te={__name:"Settings",setup(Ee){const I=i("server"),B=i(!1),Q=i([]),p=i({host:"0.0.0.0",port:8080,ws_port:8765}),U=i({url:"sqlite+aiosqlite:///./data/dispatcher.db"}),g=i({level:"INFO",file:"./logs/dispatcher.log"}),d=i({action:"reject",target_ws:"",message:"未知指令，请使用 /help 查看帮助",send_message:!0}),_=i([]),v=i([]),S=i(""),G=i(!1),A=i(null),x=i(!0),b=i(!1);let c=null;const K=fe(()=>S.value?v.value.filter(t=>t.level===S.value):v.value),Y=async()=>{try{const[t,l]=await Promise.all([H.get(),ie.getAll()]);Q.value=l,t.server&&(p.value={...t.server}),t.database&&(U.value={...t.database}),t.logging&&(g.value={...t.logging}),t.final&&(d.value={...t.final}),t.admins&&(_.value=[...t.admins])}catch(t){console.error("Load config error:",t),L.error("加载配置失败")}},j=async()=>{G.value=!0;try{const t=await me.getLogs();v.value=t||[],await J(),q()}catch(t){console.error("Load logs error:",t),L.error("加载日志失败")}finally{G.value=!1}},q=()=>{A.value&&(A.value.scrollTop=A.value.scrollHeight)},Z=()=>{v.value=[]},W=()=>{c&&c.close();const l=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/logs`;c=new WebSocket(l),c.onopen=()=>{b.value=!0,v.value=[]},c.onmessage=V=>{try{const n=JSON.parse(V.data);if(n.error){L.error(n.error);return}v.value.push(n),v.value.length>X&&(v.value=v.value.slice(-X)),J(q)}catch(n){console.error("Parse log error:",n)}},c.onclose=()=>{b.value=!1,x.value&&setTimeout(W,3e3)},c.onerror=()=>{b.value=!1}},M=()=>{c&&(c.close(),c=null),b.value=!1},ee=t=>{t?W():(M(),j())},le=()=>{_.value.push(0)},ae=t=>{_.value.splice(t,1)},oe=async()=>{B.value=!0;try{await H.update({server:p.value,database:U.value,logging:g.value,final:d.value,admins:_.value.filter(t=>t>0)}),L.success("配置保存成功，请重启服务使配置生效")}catch(t){console.error("Save config error:",t),L.error("保存失败")}finally{B.value=!1}};return ce(()=>{Y(),x.value&&W()}),pe(()=>{M()}),(t,l)=>{const V=u("el-input"),n=u("el-form-item"),z=u("el-input-number"),T=u("el-form"),y=u("el-tab-pane"),te=u("Plus"),E=u("el-icon"),R=u("el-button"),se=u("Delete"),m=u("el-option"),F=u("el-select"),$=u("el-switch"),ne=u("Refresh"),ue=u("el-tag"),de=u("el-tabs"),re=u("Check");return r(),f("div",ge,[e(de,{modelValue:I.value,"onUpdate:modelValue":l[12]||(l[12]=a=>I.value=a)},{default:o(()=>[e(y,{label:"服务器配置",name:"server"},{default:o(()=>[s("div",be,[e(T,{model:p.value,"label-width":"140px"},{default:o(()=>[e(n,{label:"HTTP 监听地址"},{default:o(()=>[e(V,{modelValue:p.value.host,"onUpdate:modelValue":l[0]||(l[0]=a=>p.value.host=a),placeholder:"0.0.0.0",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),e(n,{label:"HTTP 端口"},{default:o(()=>[e(z,{modelValue:p.value.port,"onUpdate:modelValue":l[1]||(l[1]=a=>p.value.port=a),min:1,max:65535},null,8,["modelValue"])]),_:1}),e(n,{label:"WebSocket 端口"},{default:o(()=>[e(z,{modelValue:p.value.ws_port,"onUpdate:modelValue":l[2]||(l[2]=a=>p.value.ws_port=a),min:1,max:65535},null,8,["modelValue"]),l[13]||(l[13]=s("div",{class:"form-tip"},"NapCat 连接到此端口",-1))]),_:1})]),_:1},8,["model"])])]),_:1}),e(y,{label:"管理员",name:"admins"},{default:o(()=>[s("div",Ve,[s("div",ye,[l[15]||(l[15]=s("h3",null,"管理员 QQ 号",-1)),e(R,{type:"primary",size:"small",onClick:le},{default:o(()=>[e(E,null,{default:o(()=>[e(te)]),_:1}),l[14]||(l[14]=N(" 添加 ",-1))]),_:1})]),_.value.length===0?(r(),f("div",we,"暂无管理员")):k("",!0),(r(!0),f(D,null,P(_.value,(a,w)=>(r(),f("div",{key:w,class:"admin-item"},[e(z,{modelValue:_.value[w],"onUpdate:modelValue":C=>_.value[w]=C,controls:!1,placeholder:"输入 QQ 号",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),e(R,{type:"danger",size:"small",onClick:C=>ae(w)},{default:o(()=>[e(E,null,{default:o(()=>[e(se)]),_:1})]),_:1},8,["onClick"])]))),128))])]),_:1}),e(y,{label:"数据库",name:"database"},{default:o(()=>[s("div",ke,[e(T,{model:U.value,"label-width":"140px"},{default:o(()=>[e(n,{label:"数据库 URL"},{default:o(()=>[e(V,{modelValue:U.value.url,"onUpdate:modelValue":l[3]||(l[3]=a=>U.value.url=a),placeholder:"sqlite+aiosqlite:///./data/dispatcher.db",style:{width:"400px"}},null,8,["modelValue"]),l[16]||(l[16]=s("div",{class:"form-tip"},"支持 SQLite 和其他 SQLAlchemy 兼容的数据库",-1))]),_:1})]),_:1},8,["model"])])]),_:1}),e(y,{label:"日志设置",name:"logging"},{default:o(()=>[s("div",he,[e(T,{model:g.value,"label-width":"140px"},{default:o(()=>[e(n,{label:"日志级别"},{default:o(()=>[e(F,{modelValue:g.value.level,"onUpdate:modelValue":l[4]||(l[4]=a=>g.value.level=a),style:{width:"150px"}},{default:o(()=>[e(m,{label:"DEBUG",value:"DEBUG"}),e(m,{label:"INFO",value:"INFO"}),e(m,{label:"WARNING",value:"WARNING"}),e(m,{label:"ERROR",value:"ERROR"})]),_:1},8,["modelValue"])]),_:1}),e(n,{label:"日志文件"},{default:o(()=>[e(V,{modelValue:g.value.file,"onUpdate:modelValue":l[5]||(l[5]=a=>g.value.file=a),placeholder:"./logs/dispatcher.log",style:{width:"300px"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1}),e(y,{label:"日志查看",name:"logs"},{default:o(()=>[s("div",Ue,[s("div",xe,[e(F,{modelValue:S.value,"onUpdate:modelValue":l[6]||(l[6]=a=>S.value=a),placeholder:"日志级别",style:{width:"120px"},size:"small"},{default:o(()=>[e(m,{label:"全部",value:""}),e(m,{label:"DEBUG",value:"DEBUG"}),e(m,{label:"INFO",value:"INFO"}),e(m,{label:"WARNING",value:"WARNING"}),e(m,{label:"ERROR",value:"ERROR"})]),_:1},8,["modelValue"]),e($,{modelValue:x.value,"onUpdate:modelValue":l[7]||(l[7]=a=>x.value=a),"active-text":"实时","inactive-text":"手动",style:{"margin-left":"10px"},onChange:ee},null,8,["modelValue"]),x.value?(r(),h(ue,{key:1,type:b.value?"success":"danger",size:"small"},{default:o(()=>[N(O(b.value?"已连接":"未连接"),1)]),_:1},8,["type"])):(r(),h(R,{key:0,type:"primary",size:"small",onClick:j,loading:G.value},{default:o(()=>[e(E,null,{default:o(()=>[e(ne)]),_:1}),l[17]||(l[17]=N(" 刷新 ",-1))]),_:1},8,["loading"])),e(R,{size:"small",onClick:Z},{default:o(()=>[...l[18]||(l[18]=[N(" 清空显示 ",-1)])]),_:1})]),s("div",{class:"logs-container",ref_key:"logsContainer",ref:A},[v.value.length===0?(r(),f("div",Re,"暂无日志")):k("",!0),(r(!0),f(D,null,P(K.value,(a,w)=>{var C;return r(),f("div",{key:w,class:_e(["log-line",`log-${(C=a.level)==null?void 0:C.toLowerCase()}`])},[s("span",Ce,O(a.time),1),s("span",Ne,O(a.level),1),s("span",Le,O(a.message),1)],2)}),128))],512)])]),_:1}),e(y,{label:"默认规则",name:"final"},{default:o(()=>[s("div",Se,[e(T,{model:d.value,"label-width":"140px"},{default:o(()=>[e(n,{label:"未匹配指令处理"},{default:o(()=>[e(F,{modelValue:d.value.action,"onUpdate:modelValue":l[8]||(l[8]=a=>d.value.action=a),style:{width:"150px"}},{default:o(()=>[e(m,{label:"拒绝",value:"reject"}),e(m,{label:"允许",value:"allow"}),e(m,{label:"转发",value:"forward"})]),_:1},8,["modelValue"])]),_:1}),d.value.action==="forward"?(r(),h(n,{key:0,label:"目标连接"},{default:o(()=>[e(F,{modelValue:d.value.target_ws,"onUpdate:modelValue":l[9]||(l[9]=a=>d.value.target_ws=a),placeholder:"选择连接",style:{width:"200px"}},{default:o(()=>[(r(!0),f(D,null,P(Q.value,a=>(r(),h(m,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):k("",!0),d.value.action==="reject"?(r(),h(n,{key:1,label:"发送拒绝消息"},{default:o(()=>[e($,{modelValue:d.value.send_message,"onUpdate:modelValue":l[10]||(l[10]=a=>d.value.send_message=a)},null,8,["modelValue"]),l[19]||(l[19]=s("div",{class:"form-tip"},"关闭后，未匹配的指令将被静默忽略",-1))]),_:1})):k("",!0),d.value.action==="reject"&&d.value.send_message?(r(),h(n,{key:2,label:"拒绝消息"},{default:o(()=>[e(V,{modelValue:d.value.message,"onUpdate:modelValue":l[11]||(l[11]=a=>d.value.message=a),placeholder:"未知指令",style:{width:"400px"}},null,8,["modelValue"])]),_:1})):k("",!0)]),_:1},8,["model"])])]),_:1})]),_:1},8,["modelValue"]),I.value!=="logs"?(r(),f("div",Ae,[e(R,{type:"primary",size:"large",onClick:oe,loading:B.value},{default:o(()=>[e(E,null,{default:o(()=>[e(re)]),_:1}),l[20]||(l[20]=N(" 保存配置 ",-1))]),_:1},8,["loading"]),l[21]||(l[21]=s("span",{class:"save-tip"},"修改后需要重启服务才能生效",-1))])):k("",!0)])}}},Be=ve(Te,[["__scopeId","data-v-d4ce9556"]]);export{Be as default};
